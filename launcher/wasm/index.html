<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <style>
      body {
        background: linear-gradient(
          135deg,
          white 0%,
          white 49%,
          black 49%,
          black 51%,
          white 51%,
          white 100%
        ) repeat;
        background-size: 20px 20px;
        margin: 0;
        /* 针对移动端的滚动禁用 */
        overflow: hidden;
        -webkit-overflow-scrolling: auto; /* 禁用惯性滚动 */
        overscroll-behavior: none;
        touch-action: none;
      }
      canvas {
        background-color: white;
        display: block; /* 避免底部出现空白 */
        /* 去除焦点时的白边/轮廓 */
        outline: none;
        -webkit-tap-highlight-color: transparent;
        -webkit-touch-callout: none;
      }
    </style>
    <title>WASM Example</title>
  </head>
  <script type="module">
    import init from '../target/crab_feast_wasm.js'


    let bevy_window_size_buffer;

    let initlizeWindowSizeBuffer;

    function getWindowSize() {
      if (!bevy_window_size_buffer) {
        initlizeWindowSizeBuffer();
      }
      return {
        width: bevy_window_size_buffer[0],
        height: bevy_window_size_buffer[1]
      };
    }

    function getPhysicalWindowSize() {
      if (!bevy_window_size_buffer) {
        initlizeWindowSizeBuffer();
      }
      return {
        width: bevy_window_size_buffer[2],
        height: bevy_window_size_buffer[3]
      };
    }

    function getWindowScaleFactor() {
      if (!bevy_window_size_buffer) {
        initlizeWindowSizeBuffer();
      }
      return bevy_window_size_buffer[4];
    }


    window.onload = async () => {

      const wasm = await init();

      console.log(Object.keys(wasm)); // 列出所有可用属性
      console.log(wasm); // 查看完整对象

      initlizeWindowSizeBuffer = function() {
        if (!bevy_window_size_buffer) {
          bevy_window_size_buffer = new Float32Array(wasm.memory.buffer, wasm.get_window_size_buffer_ptr(), wasm.get_window_size_buffer_len())
          console.log(bevy_window_size_buffer);
        }
      }

      const canvas = document.getElementById('bevy');

      const processEvents = ["pointerout", "pointerover", "pointermove", "pointerdown", "pointerup", "pointercancel"];

      processEvents.forEach(eventName => {
        canvas.addEventListener(eventName, function(originalEvent) {
          if (originalEvent.intercepted) return;
          // console.log('pointerdown pos:', originalEvent.offsetX, originalEvent.offsetY);
          originalEvent.stopImmediatePropagation();
            
          // 将css坐标系转换到bevy逻辑坐标系
          const rect = canvas.getBoundingClientRect();
          const windowSize = getWindowSize();
          const scaleX = windowSize.width / rect.width;
          const scaleY = windowSize.height / rect.height;
          
          // 创建具有新坐标的事件
          const newEvent = new PointerEvent(eventName, {
              ...originalEvent,
              pointerId: originalEvent.pointerId,
              pointerType: originalEvent.pointerType,
              isPrimary: originalEvent.isPrimary,
          });

          Object.defineProperties(newEvent, {
              offsetX: { value: originalEvent.offsetX * scaleX },
              offsetY: { value: originalEvent.offsetY * scaleY },
          });

          newEvent.intercepted = true; // 标记事件已被处理

          // console.log('pointerdown new pos:', newEvent.offsetX, newEvent.offsetY);
          
          // 触发到 canvas
          canvas.dispatchEvent(newEvent);
        });   
      });
    };

  </script>
  <body>
      <canvas id="bevy" width="1280" height="720"></canvas>
  </body>
</html>
