<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <style>
      body {
        background: linear-gradient(
          135deg,
          white 0%,
          white 49%,
          black 49%,
          black 51%,
          white 51%,
          white 100%
        ) repeat;
        background-size: 20px 20px;
        margin: 0;
        /* 针对移动端的滚动禁用 */
        overflow: hidden;
        -webkit-overflow-scrolling: auto; /* 禁用惯性滚动 */
        overscroll-behavior: none;
        touch-action: none;
      }
      canvas {
        background-color: white;
        display: block; /* 避免底部出现空白 */
        /* 去除焦点时的白边/轮廓 */
        outline: none;
        -webkit-tap-highlight-color: transparent;
        -webkit-touch-callout: none;
      }
    </style>
    <title>WASM Example</title>
  </head>
  <script type="module">
    import init from '../target/crab_feast_wasm.js'


    /**
     * [width, height, physical_width, physical_height, scale_factor]
     */
    let bevy_window_size_buffer;

    function getWindowSize() {
      initlizeWindowSizeBuffer();
      return {
        width: bevy_window_size_buffer[0],
        height: bevy_window_size_buffer[1]
      };
    }

    function getPhysicalWindowSize() {
      initlizeWindowSizeBuffer();
      return {
        width: bevy_window_size_buffer[2],
        height: bevy_window_size_buffer[3]
      };
    }

    function getWindowScaleFactor() {
      initlizeWindowSizeBuffer();
      return bevy_window_size_buffer[4];
    }

    function initlizeWindowSizeBuffer () {
      if (!bevy_window_size_buffer || bevy_window_size_buffer.length === 0) {
        const bufferPtr = wasm.get_window_size_buffer_ptr();
        const bufferLen = wasm.get_window_size_buffer_len();
        if (bufferPtr === 0 || bufferLen === 0) {
          throw new Error("Failed to get Bevy window size buffer from WASM.");
        }
        bevy_window_size_buffer = new Float32Array(wasm.memory.buffer, bufferPtr, bufferLen);
        console.log(bevy_window_size_buffer);
      }
    };

    let wasm;

    window.onload = async () => {

      const canvas = document.getElementById('bevy');

      const processEvents = ["pointerout", "pointerover", "pointermove", "pointerdown", "pointerup", "pointercancel"];

      processEvents.forEach(eventName => {
        canvas.addEventListener(eventName, function(event) {
          // 将css坐标系转换到bevy逻辑坐标系
          const rect = canvas.getBoundingClientRect();
          const windowSize = getWindowSize();
          const scaleX = windowSize.width / rect.width;
          const scaleY = windowSize.height / rect.height;

          const postion = {x: event.offsetX * scaleX, y: event.offsetY * scaleY};
          console.log(`event ${eventName} old pos: ${event.offsetX}, ${event.offsetY} new pos: ${postion.x}, ${postion.y}`);

          const getCoalescedEvents = event.getCoalescedEvents;

          Object.defineProperties(event, {
              offsetX: { value: postion.x },
              offsetY: { value: postion.y },
              getCoalescedEvents: {
                value: function() {
                  return Array.from(getCoalescedEvents.call(event)).map(e => ({
                    ...e,
                    offsetX: e.offsetX * scaleX,
                    offsetY: e.offsetY * scaleY
                  }));
                }
              }
          });
        });   
      });
    
      wasm = await init();

      console.log(Object.keys(wasm)); // 列出所有可用属性
      console.log(wasm); // 查看完整对象
    };

  </script>
  <body>
      <canvas id="bevy" width="1280" height="720"></canvas>
  </body>
</html>
